name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release Archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist
          tar -czvf dist/claude-context-watch-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='.github' \
            bin/ lib/ install.sh uninstall.sh README.md LICENSE

      - name: Calculate SHA256
        id: sha
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          SHA=$(sha256sum dist/claude-context-watch-${VERSION}.tar.gz | cut -d' ' -f1)
          echo "sha256=${SHA}" >> $GITHUB_OUTPUT
          echo "SHA256: ${SHA}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
          body: |
            ## Claude Context Watch ${{ github.ref_name }}

            Real-time context window monitor for Claude Code.

            ### Installation

            **Via Homebrew (macOS):**
            ```bash
            brew tap anthropics/claude-context-watch
            brew install claude-context-watch
            ```

            **Manual Installation:**
            ```bash
            curl -fsSL https://github.com/anthropics/claude-context-watch/releases/download/${{ github.ref_name }}/claude-context-watch-${{ github.ref_name }}.tar.gz | tar -xz
            cd claude-context-watch-${{ github.ref_name }}
            ./install.sh
            ```

            ### SHA256
            ```
            ${{ steps.sha.outputs.sha256 }}
            ```

            ### What's New
            See [CHANGELOG.md](https://github.com/anthropics/claude-context-watch/blob/main/CHANGELOG.md) for details.
          draft: false
          prerelease: false

  update-formula:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Formula SHA256
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          # Download the release tarball
          curl -fsSL -o release.tar.gz \
            "https://github.com/anthropics/claude-context-watch/archive/refs/tags/${VERSION}.tar.gz"
          SHA=$(sha256sum release.tar.gz | cut -d' ' -f1)

          # Update Formula
          sed -i "s/PLACEHOLDER_SHA256/${SHA}/" Formula/claude-context-watch.rb
          sed -i "s|v1.0.0.tar.gz|${VERSION}.tar.gz|" Formula/claude-context-watch.rb

          echo "Updated SHA256: ${SHA}"

      - name: Commit Formula Update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/claude-context-watch.rb
          git commit -m "Update formula for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed - may need manual update"
